<%- include('../partials/header') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="fas fa-credit-card"></i> Thanh to√°n
      </h2>
      
      <form action="/orders" method="POST" id="checkout-form">
        <div class="row">
          <!-- Th√¥ng tin giao h√†ng -->
          <div class="col-lg-8">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Th√¥ng tin giao h√†ng</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="fullName" class="form-label">H·ªç v√† t√™n *</label>
                    <input type="text" 
                           class="form-control" 
                           id="fullName" 
                           name="fullName" 
                           value="<%= user.profile?.fullName || '' %>" 
                           required>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                    <input type="tel" 
                           class="form-control" 
                           id="phone" 
                           name="phone" 
                           value="<%= user.profile?.phone || '' %>" 
                           required>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="city" class="form-label">Th√†nh ph·ªë *</label>
                    <input type="text" 
                           class="form-control" 
                           id="city" 
                           name="city" 
                           value="<%= user.profile?.city || '' %>" 
                           required>
                  </div>
                  
                  <div class="col-md-12 mb-3">
                    <label for="address" class="form-label">ƒê·ªãa ch·ªâ *</label>
                    <input type="text" 
                           class="form-control" 
                           id="address" 
                           name="address" 
                           value="<%= user.profile?.address || '' %>" 
                           placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£"
                           required>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="postalCode" class="form-label">M√£ b∆∞u ƒëi·ªán</label>
                    <input type="text" 
                           class="form-control" 
                           id="postalCode" 
                           name="postalCode" 
                           value="<%= user.profile?.postalCode || '' %>">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-credit-card"></i> Ph∆∞∆°ng th·ª©c thanh to√°n
                </h5>
              </div>
              <div class="card-body">
                <!-- COD -->
                <div class="form-check mb-3 p-3 border rounded">
                  <input class="form-check-input" 
                         type="radio" 
                         name="paymentMethod" 
                         id="cash_on_delivery" 
                         value="cash_on_delivery" 
                         checked>
                  <label class="form-check-label w-100" for="cash_on_delivery">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-money-bill fa-2x text-success me-3"></i>
                      <div>
                        <strong>Thanh to√°n khi nh·∫≠n h√†ng (COD)</strong>
                        <br>
                        <small class="text-muted">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n ƒë∆∞·ª£c h√†ng</small>
                      </div>
                    </div>
                  </label>
                </div>
                
                <!-- Chuy·ªÉn kho·∫£n -->
                <div class="form-check mb-3 p-3 border rounded">
                  <input class="form-check-input" 
                         type="radio" 
                         name="paymentMethod" 
                         id="bank_transfer" 
                         value="bank_transfer">
                  <label class="form-check-label w-100" for="bank_transfer">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-university fa-2x text-primary me-3"></i>
                      <div>
                        <strong>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong>
                        <br>
                        <small class="text-muted">Chuy·ªÉn kho·∫£n tr∆∞·ªõc khi giao h√†ng</small>
                      </div>
                    </div>
                  </label>
                  
                  <!-- Th√¥ng tin chuy·ªÉn kho·∫£n (·∫©n ban ƒë·∫ßu) -->
                  <div id="bank-info" class="mt-3 d-none">
                    <div class="alert alert-info">
                      <h6><i class="fas fa-info-circle"></i> Th√¥ng tin chuy·ªÉn kho·∫£n:</h6>
                      <p class="mb-1"><strong>Ng√¢n h√†ng:</strong> Vietcombank</p>
                      <p class="mb-1"><strong>S·ªë t√†i kho·∫£n:</strong> 1234567890</p>
                      <p class="mb-1"><strong>T√™n t√†i kho·∫£n:</strong> BOOKSTORE COMPANY</p>
                      <p class="mb-0"><strong>N·ªôi dung:</strong> [M√£ ƒë∆°n h√†ng] [T√™n kh√°ch h√†ng]</p>
                    </div>
                  </div>
                </div>
                
                <!-- VNPay -->
                <div class="form-check mb-3 p-3 border rounded">
                  <input class="form-check-input" 
                         type="radio" 
                         name="paymentMethod" 
                         id="vnpay" 
                         value="vnpay">
                  <label class="form-check-label w-100" for="vnpay">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-wallet fa-2x text-info me-3"></i>
                      <div>
                        <strong>Thanh to√°n qua VNPay</strong>
                        <br>
                        <small class="text-muted">Thanh to√°n tr·ª±c tuy·∫øn qua c·ªïng VNPay (ATM, th·∫ª t√≠n d·ª•ng, v√≠ ƒëi·ªán t·ª≠)</small>
                      </div>
                    </div>
                  </label>
                  
                  <!-- Th√¥ng tin VNPay (·∫©n ban ƒë·∫ßu) -->
                  <div id="vnpay-info" class="mt-3 d-none">
                    <div class="alert alert-info">
                      <i class="fas fa-info-circle"></i>
                      <strong>Th√¥ng tin:</strong> B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang thanh to√°n VNPay ƒë·ªÉ ho√†n t·∫•t giao d·ªãch. H·ªó tr·ª£ thanh to√°n qua ATM, th·∫ª t√≠n d·ª•ng/ghi n·ª£, v√† c√°c v√≠ ƒëi·ªán t·ª≠.
                    </div>
                  </div>
                </div>
                
                <!-- Th·∫ª t√≠n d·ª•ng -->
                <div class="form-check mb-3 p-3 border rounded">
                  <input class="form-check-input" 
                         type="radio" 
                         name="paymentMethod" 
                         id="credit_card" 
                         value="credit_card">
                  <label class="form-check-label w-100" for="credit_card">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-credit-card fa-2x text-warning me-3"></i>
                      <div>
                        <strong>Th·∫ª t√≠n d·ª•ng/ghi n·ª£</strong>
                        <br>
                        <small class="text-muted">Visa, Mastercard, JCB (T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn)</small>
                      </div>
                    </div>
                  </label>
                  
                  <!-- Form th·∫ª t√≠n d·ª•ng (·∫©n ban ƒë·∫ßu) -->
                  <div id="credit-card-info" class="mt-3 d-none">
                    <div class="alert alert-warning">
                      <i class="fas fa-exclamation-triangle"></i>
                      <strong>Th√¥ng b√°o:</strong> T√≠nh nƒÉng thanh to√°n b·∫±ng th·∫ª ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ghi ch√∫ -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Ghi ch√∫ ƒë∆°n h√†ng</h5>
              </div>
              <div class="card-body">
                <textarea class="form-control" 
                          name="notes" 
                          rows="3" 
                          placeholder="Ghi ch√∫ th√™m cho ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
              </div>
            </div>
          </div>
          
          <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
          <div class="col-lg-4">
            <% if (promotions && promotions.length) { %>
              <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">M√£ khuy·∫øn m√£i kh·∫£ d·ª•ng</h5>
                  <span class="badge bg-primary"><%= promotions.length %> m√£</span>
                </div>
                <div class="card-body">
                  <% promotions.forEach(function(promo) { %>
                    <div class="border rounded p-3 mb-3 promotion-option">
                      <div class="d-flex justify-content-between flex-wrap align-items-center mb-2">
                        <div>
                          <span class="badge bg-success me-2">CODE</span>
                          <strong><%= promo.code %></strong>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-outline-primary select-promo-btn"
                                data-code="<%= promo.code %>">
                          Ch·ªçn
                        </button>
                      </div>
                      <p class="mb-2 small text-muted"><%= promo.description %></p>
                      <div class="small text-muted">
                        <div>Gi·∫£m: 
                          <% if (promo.discountType === 'percentage') { %>
                            <%= promo.discountValue %>%
                          <% } else { %>
                            <%= promo.discountValue.toLocaleString('vi-VN') %> ƒë
                          <% } %>
                        </div>
                        <% if (promo.minimumPurchase > 0) { %>
                          <div>√Åp d·ª•ng cho ƒë∆°n t·ª´ <%= promo.minimumPurchase.toLocaleString('vi-VN') %> ƒë</div>
                        <% } %>
                        <div>H·∫øt h·∫°n: <%= new Date(promo.endDate).toLocaleDateString('vi-VN') %></div>
                        <% if (promo.remainingUsage !== null) { %>
                          <div>C√≤n l·∫°i: <%= promo.remainingUsage %> l∆∞·ª£t</div>
                        <% } %>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </div>
            <% } %>
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">ƒê∆°n h√†ng c·ªßa b·∫°n</h5>
              </div>
              <div class="card-body">
                <!-- Danh s√°ch s√°ch -->
                <% cart.items.forEach(function(item) { %>
                  <div class="d-flex justify-content-between mb-2">
                    <div class="flex-grow-1">
                      <small class="text-truncate d-block" style="max-width: 150px;">
                        <%= item.book.title %>
                      </small>
                      <small class="text-muted">x <%= item.quantity %></small>
                    </div>
                    <div>
                      <small><%= (item.price * item.quantity).toLocaleString('vi-VN') %> ƒë</small>
                    </div>
                  </div>
                <% }); %>
                
                <hr>
                
                <!-- T·ªïng ti·ªÅn -->
                <div class="d-flex justify-content-between mb-2">
                  <span>T·∫°m t√≠nh:</span>
                  <span id="orderSubtotal" data-value="<%= cart.totalAmount %>">
                    <%= cart.totalAmount.toLocaleString('vi-VN') %> ƒë
                  </span>
                </div>
                
                <div class="d-flex justify-content-between mb-2">
                  <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                  <span id="shippingFeeValue" data-value="<%= shippingFee %>">
                    <% if (shippingFee === 0) { %>
                      <span class="text-success">Mi·ªÖn ph√≠</span>
                    <% } else { %>
                      <%= shippingFee.toLocaleString('vi-VN') %> ƒë
                    <% } %>
                  </span>
                </div>
                
                <% if (cart.totalAmount < 500000) { %>
                  <small class="text-muted mb-2">
                    <% if (cart.totalAmount < 200000) { %>
                      üí° Mua th√™m <%= (200000 - cart.totalAmount).toLocaleString('vi-VN') %> ƒë ƒë·ªÉ gi·∫£m ph√≠ ship
                    <% } else { %>
                      üí° Mua th√™m <%= (500000 - cart.totalAmount).toLocaleString('vi-VN') %> ƒë ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ ship
                    <% } %>
                  </small>
                <% } %>
                
                <div class="mb-3">
                  <label for="promotionCode" class="form-label">M√£ khuy·∫øn m√£i</label>
                  <div class="input-group">
                    <input type="text"
                           class="form-control text-uppercase"
                           id="promotionCode"
                           name="promotionCode"
                           placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i">
                    <button class="btn btn-outline-primary" type="button" id="applyPromotionBtn">
                      √Åp d·ª•ng
                    </button>
                  </div>
                  <div class="form-text d-none" id="promotionMessage"></div>
                </div>

                <div class="d-flex justify-content-between mb-2 d-none" id="discountRow">
                  <span>Gi·∫£m gi√°:</span>
                  <span class="text-success" id="discountAmount">- 0 ƒë</span>
                </div>

                <hr>
                
                <div class="d-flex justify-content-between mb-3">
                  <strong>T·ªïng c·ªông:</strong>
                  <strong class="text-primary"
                          id="finalAmountDisplay"
                          data-subtotal="<%= cart.totalAmount %>"
                          data-shipping="<%= shippingFee %>">
                    <%= (cart.totalAmount + shippingFee).toLocaleString('vi-VN') %> ƒë
                  </strong>
                </div>
                
                <!-- N√∫t ƒë·∫∑t h√†ng -->
                <button type="submit" class="btn btn-success w-100 btn-lg">
                  <i class="fas fa-check"></i> ƒê·∫∑t h√†ng
                </button>
                
                <a href="/cart" class="btn btn-outline-secondary w-100 mt-2">
                  <i class="fas fa-arrow-left"></i> Quay l·∫°i gi·ªè h√†ng
                </a>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// X·ª≠ l√Ω hi·ªÉn th·ªã th√¥ng tin ph∆∞∆°ng th·ª©c thanh to√°n
document.addEventListener('DOMContentLoaded', function() {
  const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
  
  paymentMethods.forEach(method => {
    method.addEventListener('change', function() {
      // ·∫®n t·∫•t c·∫£ th√¥ng tin chi ti·∫øt
      document.getElementById('bank-info').classList.add('d-none');
      document.getElementById('credit-card-info').classList.add('d-none');
      document.getElementById('vnpay-info').classList.add('d-none');
      
      // Hi·ªÉn th·ªã th√¥ng tin t∆∞∆°ng ·ª©ng
      if (this.value === 'bank_transfer') {
        document.getElementById('bank-info').classList.remove('d-none');
      } else if (this.value === 'credit_card') {
        document.getElementById('credit-card-info').classList.remove('d-none');
      } else if (this.value === 'vnpay') {
        document.getElementById('vnpay-info').classList.remove('d-none');
      }
    });
  });
});

document.getElementById('checkout-form').addEventListener('submit', function(e) {
  // Validate form
  const requiredFields = ['fullName', 'phone', 'address', 'city'];
  let isValid = true;
  
  // Validate required fields
  requiredFields.forEach(fieldName => {
    const field = document.getElementById(fieldName);
    if (!field.value.trim()) {
      field.classList.add('is-invalid');
      isValid = false;
    } else {
      field.classList.remove('is-invalid');
    }
  });
  
  // Validate payment method
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
  if (!paymentMethod) {
    alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n');
    isValid = false;
  }
  
  // Check if credit card is selected (not implemented)
  if (paymentMethod && paymentMethod.value === 'credit_card') {
    alert('T√≠nh nƒÉng thanh to√°n b·∫±ng th·∫ª ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.');
    isValid = false;
  }
  
  if (!isValid) {
    e.preventDefault();
    if (requiredFields.some(field => !document.getElementById(field).value.trim())) {
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
    }
  }
});

const discountRow = document.getElementById('discountRow');
const discountAmountEl = document.getElementById('discountAmount');
const finalAmountEl = document.getElementById('finalAmountDisplay');
const promotionMessage = document.getElementById('promotionMessage');
const promotionInput = document.getElementById('promotionCode');
const applyPromotionBtn = document.getElementById('applyPromotionBtn');
const promotionSelectButtons = document.querySelectorAll('.select-promo-btn');

const baseSubtotal = Number(finalAmountEl?.dataset.subtotal || 0);
const baseShipping = Number(finalAmountEl?.dataset.shipping || 0);

const updateDiscountDisplay = (discount = 0) => {
  if (!discountRow || !discountAmountEl || !finalAmountEl) {
    return;
  }
  if (discount > 0) {
    discountRow.classList.remove('d-none');
    discountAmountEl.textContent = `- ${discount.toLocaleString('vi-VN')} ƒë`;
  } else {
    discountRow.classList.add('d-none');
  }

  const finalAmount = Math.max(0, baseSubtotal + baseShipping - discount);
  finalAmountEl.textContent = `${finalAmount.toLocaleString('vi-VN')} ƒë`;
};

if (applyPromotionBtn) {
  const originalBtnText = applyPromotionBtn.innerHTML;

  const handleApplyPromotion = async (codeOverride) => {
    if (!promotionMessage || !promotionInput) {
      return;
    }

    promotionMessage.classList.add('d-none');
    promotionMessage.classList.remove('text-success', 'text-danger');

    const code = (codeOverride || promotionInput.value || '').trim();
    if (!code) {
      promotionMessage.textContent = 'Vui l√≤ng nh·∫≠p m√£ khuy·∫øn m√£i';
      promotionMessage.classList.add('text-danger');
      promotionMessage.classList.remove('d-none');
      updateDiscountDisplay(0);
      return;
    }

    applyPromotionBtn.disabled = true;
    applyPromotionBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ƒêang √°p d·ª•ng';

    try {
      const response = await fetch('/orders/apply-promotion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ code })
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Kh√¥ng th·ªÉ √°p d·ª•ng m√£ khuy·∫øn m√£i');
      }

      promotionInput.value = (data.promotion?.code || code).toUpperCase();
      promotionMessage.textContent = data.promotion?.description || 'ƒê√£ √°p d·ª•ng m√£ khuy·∫øn m√£i';
      promotionMessage.classList.add('text-success');
      promotionMessage.classList.remove('text-danger', 'd-none');

      updateDiscountDisplay(data.discountAmount || 0);
    } catch (error) {
      promotionMessage.textContent = error.message || 'Kh√¥ng th·ªÉ √°p d·ª•ng m√£ khuy·∫øn m√£i';
      promotionMessage.classList.add('text-danger');
      promotionMessage.classList.remove('text-success', 'd-none');
      updateDiscountDisplay(0);
    } finally {
      applyPromotionBtn.disabled = false;
      applyPromotionBtn.innerHTML = originalBtnText;
    }
  };

  applyPromotionBtn.addEventListener('click', () => handleApplyPromotion());

  if (promotionSelectButtons.length > 0) {
    promotionSelectButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const code = (btn.dataset.code || '').trim();
        promotionInput.value = code;
        handleApplyPromotion(code);
      });
    });
  }
}
</script>

<%- include('../partials/footer') %>