<%- include('../partials/header') %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">
        <i class="fas fa-shopping-cart"></i> Giỏ hàng
      </h2>
      
      <% if (cart.items && cart.items.length > 0) { %>
        <div class="row">
          <!-- Cart Items -->
          <div class="col-lg-8">
            <div class="card">
              <div class="card-body">
                <% cart.items.forEach(function(item) { %>
                  <div class="row cart-item mb-3 pb-3 border-bottom" data-book-id="<%= item.book._id %>">
                    <div class="col-md-2">
                      <img src="<%= item.book.coverImage && item.book.coverImage.startsWith('http') ? item.book.coverImage : '/uploads/' + item.book.coverImage %>" 
                           alt="<%= item.book.title %>" 
                           class="img-fluid rounded">
                    </div>
                    <div class="col-md-4">
                      <h6 class="mb-1"><%= item.book.title %></h6>
                      <p class="text-muted mb-1">Tác giả: <%= item.book.author %></p>
                      <p class="text-primary mb-0">
                        <strong><%= (item.price).toLocaleString('vi-VN') %> đ</strong>
                      </p>
                    </div>
                    <div class="col-md-3">
                      <div class="input-group">
                        <button class="btn btn-outline-secondary btn-decrease" type="button">-</button>
                        <input type="number" 
                               class="form-control text-center quantity-input" 
                               value="<%= item.quantity %>" 
                               min="1"
                               data-price="<%= item.price %>">
                        <button class="btn btn-outline-secondary btn-increase" type="button">+</button>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <p class="mb-1">Thành tiền:</p>
                      <p class="text-primary mb-0">
                        <strong class="item-total"><%= (item.price * item.quantity).toLocaleString('vi-VN') %> đ</strong>
                      </p>
                    </div>
                    <div class="col-md-1">
                      <button class="btn btn-danger btn-sm btn-remove" 
                              onclick="removeFromCart('<%= item.book._id %>')">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
            
            <!-- Cart Actions -->
            <div class="mt-3">
              <button class="btn btn-outline-secondary me-2" onclick="clearCart()">
                <i class="fas fa-trash"></i> Xóa tất cả
              </button>
              <a href="/books" class="btn btn-primary">
                <i class="fas fa-plus"></i> Tiếp tục mua sắm
              </a>
            </div>
          </div>
          
          <!-- Order Summary -->
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Tổng đơn hàng</h5>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                  <span>Tạm tính:</span>
                  <span id="subtotal"><%= cart.totalAmount.toLocaleString('vi-VN') %> đ</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Phí vận chuyển:</span>
                  <span id="shipping-fee">
                    <% if (shippingFee === 0) { %>
                      <span class="text-success">Miễn phí</span>
                    <% } else { %>
                      <%= shippingFee.toLocaleString('vi-VN') %> đ
                    <% } %>
                  </span>
                </div>
                <% if (cart.totalAmount < 500000) { %>
                  <small class="text-muted">
                    <% if (cart.totalAmount < 200000) { %>
                      Mua thêm <%= (200000 - cart.totalAmount).toLocaleString('vi-VN') %> đ để giảm phí ship xuống 30,000 đ
                    <% } else { %>
                      Mua thêm <%= (500000 - cart.totalAmount).toLocaleString('vi-VN') %> đ để được miễn phí vận chuyển
                    <% } %>
                  </small>
                <% } %>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                  <strong>Tổng cộng:</strong>
                  <strong class="text-primary" id="total">
                    <%= finalAmount.toLocaleString('vi-VN') %> đ
                  </strong>
                </div>
                
                <a href="/orders/checkout" class="btn btn-success w-100">
                  <i class="fas fa-credit-card"></i> Thanh toán
                </a>
              </div>
            </div>
          </div>
        </div>
      <% } else { %>
        <!-- Empty Cart -->
        <div class="text-center py-5">
          <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
          <h4>Giỏ hàng trống</h4>
          <p class="text-muted mb-4">Hãy thêm sách vào giỏ hàng để tiếp tục mua sắm</p>
          <a href="/books" class="btn btn-primary">
            <i class="fas fa-book"></i> Khám phá sách
          </a>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
// Tăng/giảm số lượng
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-increase')) {
    const input = e.target.previousElementSibling;
    const currentValue = parseInt(input.value);
    input.value = currentValue + 1;
    updateCartItem(input);
  }
  
  if (e.target.classList.contains('btn-decrease')) {
    const input = e.target.nextElementSibling;
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
      input.value = currentValue - 1;
      updateCartItem(input);
    }
  }
});

// Cập nhật khi thay đổi số lượng trực tiếp
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('quantity-input')) {
    updateCartItem(e.target);
  }
});

function updateCartItem(input) {
  const cartItem = input.closest('.cart-item');
  const bookId = cartItem.getAttribute('data-book-id');
  const quantity = parseInt(input.value);
  const price = parseFloat(input.getAttribute('data-price'));
  
  if (quantity < 1) {
    input.value = 1;
    return;
  }
  
  // Cập nhật thành tiền cho item
  const itemTotal = cartItem.querySelector('.item-total');
  itemTotal.textContent = (price * quantity).toLocaleString('vi-VN') + ' đ';
  
  // Gửi request cập nhật
  fetch('/cart/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      bookId: bookId,
      quantity: quantity
    })
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => {
        throw new Error(err.message || 'Có lỗi xảy ra');
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('Cập nhật thành công:', data.message);
    updateCartTotals();
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Có lỗi xảy ra khi cập nhật giỏ hàng: ' + error.message);
  });
}

function updateCartTotals() {
  let subtotal = 0;
  document.querySelectorAll('.cart-item').forEach(item => {
    const quantity = parseInt(item.querySelector('.quantity-input').value);
    const price = parseFloat(item.querySelector('.quantity-input').getAttribute('data-price'));
    subtotal += price * quantity;
  });
  
  // Tính phí ship
  let shippingFee;
  if (subtotal >= 500000) {
    shippingFee = 0;
  } else if (subtotal >= 200000) {
    shippingFee = 30000;
  } else {
    shippingFee = 50000;
  }
  
  // Cập nhật UI
  document.getElementById('subtotal').textContent = subtotal.toLocaleString('vi-VN') + ' đ';
  
  const shippingElement = document.getElementById('shipping-fee');
  if (shippingFee === 0) {
    shippingElement.innerHTML = '<span class="text-success">Miễn phí</span>';
  } else {
    shippingElement.textContent = shippingFee.toLocaleString('vi-VN') + ' đ';
  }
  
  document.getElementById('total').textContent = (subtotal + shippingFee).toLocaleString('vi-VN') + ' đ';
}

function removeFromCart(bookId) {
  if (confirm('Bạn có chắc muốn xóa sách này khỏi giỏ hàng?')) {
    fetch(`/cart/remove/${bookId}`, {
      method: 'POST'
    })
    .then(response => {
      if (response.ok) {
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra khi xóa sách');
    });
  }
}

function clearCart() {
  if (confirm('Bạn có chắc muốn xóa tất cả sách trong giỏ hàng?')) {
    fetch('/cart/clear', {
      method: 'POST'
    })
    .then(response => {
      if (response.ok) {
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra khi xóa giỏ hàng');
    });
  }
}
</script>

<%- include('../partials/footer') %>