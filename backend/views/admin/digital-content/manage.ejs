<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-sidebar {
            background-color: #343a40;
            min-height: 100vh;
        }
        .admin-sidebar .nav-link {
            color: #adb5bd;
        }
        .admin-sidebar .nav-link:hover {
            color: #fff;
        }
        .admin-sidebar .nav-link.active {
            color: #fff;
            background-color: #495057;
        }
        .feature-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .feature-card.enabled {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .feature-card.disabled {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        .chapter-input {
            border: 1px dashed #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        .file-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 admin-sidebar p-3">
                <h4 class="text-white mb-4">
                    <i class="fas fa-cog"></i> Admin Panel
                </h4>
                <nav class="nav flex-column">
                    <a class="nav-link" href="/admin">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link" href="/admin/books">
                        <i class="fas fa-book"></i> Qu·∫£n l√Ω s√°ch
                    </a>
                    <a class="nav-link" href="/admin/inventory">
                        <i class="fas fa-warehouse"></i> Qu·∫£n l√Ω kho h√†ng
                    </a>
                    <a class="nav-link active" href="/admin/digital-content">
                        <i class="fas fa-tablet-alt"></i> N·ªôi dung s·ªë
                    </a>
                    <a class="nav-link" href="/admin/promotions">
                        <i class="fas fa-tags"></i> M√£ khuy·∫øn m√£i
                    </a>
                    <a class="nav-link" href="/admin/coin-transactions">
                        <i class="fas fa-coins"></i> Giao d·ªãch Coin
                    </a>
                    <a class="nav-link" href="/admin/users">
                        <i class="fas fa-users"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                    </a>
                    <a class="nav-link" href="/admin/categories">
                        <i class="fas fa-tags"></i> Qu·∫£n l√Ω danh m·ª•c
                    </a>
                    <a class="nav-link" href="/admin/reports">
                        <i class="fas fa-chart-line"></i> B√°o c√°o & Th·ªëng k√™
                    </a>
                    <hr class="text-secondary">
                    <a class="nav-link" href="/books">
                        <i class="fas fa-home"></i> V·ªÅ trang ch·ªß
                    </a>
                    <a class="nav-link" href="/logout">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                    <h1><%= title %></h1>
                    <div>
                        <a href="/admin/digital-content" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay l·∫°i
                        </a>
                        <span class="badge bg-primary ms-2">Admin: <%= currentUser.username %></span>
                    </div>
                </div>

                <!-- Flash Messages -->
                <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
                    <div class="alert alert-success alert-dismissible fade show mt-3">
                        <%= success_msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible fade show mt-3">
                        <%= error_msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <!-- Book Info -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin s√°ch</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <img src="<%= book.coverImage %>" alt="<%= book.title %>" class="img-fluid rounded">
                            </div>
                            <div class="col-md-10">
                                <h4><%= book.title %></h4>
                                <p class="text-muted"><strong>T√°c gi·∫£:</strong> <%= book.author %></p>
                                <p class="text-muted"><strong>Danh m·ª•c:</strong> <%= book.category?.name || 'Ch∆∞a ph√¢n lo·∫°i' %></p>
                                <p class="text-muted"><strong>Gi√° b√°n:</strong> <%= book.price.toLocaleString('vi-VN') %>‚Ç´</p>
                                <div class="mt-3">
                                    <% if (book.isDigitalAvailable) { %>
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-download"></i> Digital Available
                                        </span>
                                    <% } %>
                                    <% if (book.hasPreview) { %>
                                        <span class="badge bg-info">
                                            <i class="fas fa-eye"></i> Has Preview
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Digital Settings -->
                <div class="feature-card <%= book.isDigitalAvailable ? 'enabled' : 'disabled' %>">
                    <h5>
                        <i class="fas fa-download"></i> C√†i ƒë·∫∑t n·ªôi dung s·ªë
                    </h5>
                    <form method="POST" action="/admin/digital-content/<%= book._id %>/settings">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="isDigitalAvailable" 
                                           name="isDigitalAvailable" <%= book.isDigitalAvailable ? 'checked' : '' %>>
                                    <label class="form-check-label" for="isDigitalAvailable">
                                        B·∫≠t t√≠nh nƒÉng digital
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="coinPrice" class="form-label">Gi√° b·∫±ng Coin</label>
                                    <input type="number" class="form-control" id="coinPrice" name="coinPrice" 
                                           value="<%= book.coinPrice || '' %>" min="0" placeholder="0">
                                    <small class="text-muted">ƒê·ªÉ tr·ªëng ho·∫∑c 0 = mi·ªÖn ph√≠</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="hasPreview" 
                                           name="hasPreview" <%= book.hasPreview ? 'checked' : '' %>>
                                    <label class="form-check-label" for="hasPreview">
                                        B·∫≠t t√≠nh nƒÉng preview
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t
                        </button>
                    </form>
                </div>

                <!-- File Upload -->
                <div class="feature-card">
                    <h5>
                        <i class="fas fa-cloud-upload-alt"></i> Upload file n·ªôi dung
                    </h5>
                    
                    <% if (book.digitalContentPath) { %>
                        <div class="file-info mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>File hi·ªán t·∫°i:</strong> <%= book.digitalContentFilename %><br>
                                    <small class="text-muted">
                                        K√≠ch th∆∞·ªõc: <%= Math.round((book.digitalContentSize || 0) / 1024 / 1024 * 100) / 100 %>MB |
                                        Lo·∫°i: <%= book.digitalContentType %>
                                    </small>
                                </div>
                                <form method="POST" action="/admin/digital-content/<%= book._id %>/delete-file" 
                                      class="d-inline" onsubmit="return confirm('X√°c nh·∫≠n x√≥a file n·ªôi dung?')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash"></i> X√≥a file
                                    </button>
                                </form>
                            </div>
                        </div>
                    <% } %>

                    <form method="POST" action="/admin/digital-content/<%= book._id %>/upload" 
                          enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="contentFile" class="form-label">Ch·ªçn file n·ªôi dung</label>
                            <input class="form-control" type="file" id="contentFile" name="contentFile" 
                                   accept=".txt,.pdf,.epub,.mobi" required>
                            <small class="text-muted">
                                H·ªó tr·ª£: .txt, .pdf, .epub, .mobi (t·ªëi ƒëa 50MB)
                            </small>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload file
                        </button>
                    </form>
                </div>

                <!-- Preview Content Management -->
                <div class="feature-card">
                    <h5>
                        <i class="fas fa-eye"></i> Qu·∫£n l√Ω n·ªôi dung preview
                    </h5>
                    
                    <% if (previewContent) { %>
                        <div class="alert alert-info mb-3">
                            <strong>Preview hi·ªán t·∫°i:</strong> 
                            <%= previewContent.totalChapters %> ch∆∞∆°ng (DB), 
                            <%= previewContent.chapters ? previewContent.chapters.length : 0 %> ch∆∞∆°ng (array),
                            t·ªïng <%= previewContent.chapters ? previewContent.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0) : 0 %> t·ª´
                            <form method="POST" action="/admin/digital-content/<%= book._id %>/delete-preview" 
                                  class="d-inline ms-3" onsubmit="return confirm('X√°c nh·∫≠n x√≥a to√†n b·ªô preview?')">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    <i class="fas fa-trash"></i> X√≥a preview
                                </button>
                            </form>
                        </div>
                    <% } %>

                    <form method="POST" action="/admin/digital-content/<%= book._id %>/preview" id="previewForm" onsubmit="return submitPreviewForm(event)">
                        <div class="mb-3">
                            <label class="form-label">N·ªôi dung preview (3-5 ch∆∞∆°ng):</label>
                            <div id="chaptersContainer">
                                <% if (previewContent && previewContent.chapters) { %>
                                    <% previewContent.chapters.forEach((chapter, index) => { %>
                                        <div class="chapter-input">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng <%= index + 1 %></label>
                                                    <input type="text" class="form-control" name="chapters[<%= index %>][title]" 
                                                           value="<%= chapter.title %>" required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">N·ªôi dung</label>
                                                    <textarea class="form-control" name="chapters[<%= index %>][content]" 
                                                              rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."><%= chapter.content %></textarea>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button" class="btn btn-outline-danger btn-sm d-block delete-chapter-btn" 
                                                            data-action="delete-chapter" onclick="removeChapter(this)">
                                                        <i class="fas fa-trash"></i> X√≥a
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <!-- Default empty chapters -->
                                    <div class="chapter-input">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng 1</label>
                                                <input type="text" class="form-control" name="chapters[0][title]" 
                                                       required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">N·ªôi dung</label>
                                                <textarea class="form-control" name="chapters[0][content]" 
                                                          rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                                        onclick="removeChapter(this)">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chapter-input">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng 2</label>
                                                <input type="text" class="form-control" name="chapters[1][title]" 
                                                       required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">N·ªôi dung</label>
                                                <textarea class="form-control" name="chapters[1][content]" 
                                                          rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                                        onclick="removeChapter(this)">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chapter-input">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng 3</label>
                                                <input type="text" class="form-control" name="chapters[2][title]" 
                                                       required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">N·ªôi dung</label>
                                                <textarea class="form-control" name="chapters[2][content]" 
                                                          rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                                        onclick="removeChapter(this)">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="addChapter()" id="addChapterBtn">
                                <i class="fas fa-plus"></i> Th√™m ch∆∞∆°ng
                            </button>
                            <small class="text-muted ms-2">T·ªëi ƒëa 5 ch∆∞∆°ng, t·ªëi thi·ªÉu 3 ch∆∞∆°ng</small>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u n·ªôi dung preview
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chapterCount = document.querySelectorAll('.chapter-input').length;
        
        // Initialize chapter count on page load
        document.addEventListener('DOMContentLoaded', function() {
            chapterCount = document.querySelectorAll('.chapter-input').length;
            updateChapterControls();
            
            // S·ª≠ d·ª•ng event delegation cho n√∫t x√≥a ch∆∞∆°ng
            const chaptersContainer = document.getElementById('chaptersContainer');
            if (chaptersContainer) {
                chaptersContainer.addEventListener('click', function(e) {
                    console.log('Click event in chaptersContainer', e.target);
                    
                    // T√¨m button g·∫ßn nh·∫•t t·ª´ element ƒë∆∞·ª£c click
                    const button = e.target.closest('button');
                    
                    // Ki·ªÉm tra n·∫øu l√† n√∫t x√≥a (c√≥ data-action="delete-chapter" ho·∫∑c ch·ª©a text "X√≥a" ho·∫∑c icon trash)
                    if (button) {
                        const isDeleteButton = button.getAttribute('data-action') === 'delete-chapter' ||
                                             button.textContent.trim().includes('X√≥a') ||
                                             button.querySelector('.fa-trash') ||
                                             e.target.closest('.fa-trash');
                        
                        if (isDeleteButton) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('‚úÖ Delete button clicked', button);
                            removeChapter(button);
                        }
                    }
                });
            } else {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y chaptersContainer element');
            }
        });

        function addChapter() {
            if (chapterCount >= 5) {
                alert('T·ªëi ƒëa 5 ch∆∞∆°ng preview');
                return;
            }

            const container = document.getElementById('chaptersContainer');
            const newChapter = document.createElement('div');
            newChapter.className = 'chapter-input';
            newChapter.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng ${chapterCount + 1}</label>
                        <input type="text" class="form-control" name="chapters[${chapterCount}][title]" 
                               required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">N·ªôi dung</label>
                        <textarea class="form-control" name="chapters[${chapterCount}][content]" 
                                  rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-outline-danger btn-sm d-block delete-chapter-btn" 
                                data-action="delete-chapter" onclick="removeChapter(this)">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newChapter);
            chapterCount++;
            renumberChapters();
            updateChapterControls();
        }

        function removeChapter(button) {
            console.log('üîç removeChapter called', button);
            
            // T√¨m element ch∆∞∆°ng c·∫ßn x√≥a - ƒëi t·ª´ button l√™n ƒë·∫øn khi t√¨m th·∫•y .chapter-input
            let chapterElement = null;
            let current = button;
            
            // T√¨m t·ª´ button ƒëi l√™n
            while (current && current !== document.body) {
                if (current.classList && current.classList.contains('chapter-input')) {
                    chapterElement = current;
                    break;
                }
                current = current.parentElement;
            }
            
            // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, th·ª≠ d√πng closest
            if (!chapterElement) {
                chapterElement = button.closest('.chapter-input');
            }
            
            if (!chapterElement) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y element ch∆∞∆°ng ƒë·ªÉ x√≥a');
                console.log('Button element:', button);
                console.log('Button parent:', button.parentElement);
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng ƒë·ªÉ x√≥a. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            
            console.log('‚úÖ T√¨m th·∫•y chapter element:', chapterElement);
            
            const chapters = document.querySelectorAll('.chapter-input');
            console.log(`üìä T·ªïng s·ªë ch∆∞∆°ng hi·ªán t·∫°i: ${chapters.length}`);
            
            if (chapters.length <= 3) {
                alert('T·ªëi thi·ªÉu 3 ch∆∞∆°ng preview');
                return;
            }

            // X√°c nh·∫≠n tr∆∞·ªõc khi x√≥a
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch∆∞∆°ng n√†y?')) {
                return;
            }
            
            console.log('üóëÔ∏è ƒêang x√≥a ch∆∞∆°ng...');
            
            // X√≥a ho√†n to√†n element kh·ªèi DOM
            chapterElement.remove();
            
            // C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng
            chapterCount = document.querySelectorAll('.chapter-input').length;
            console.log(`üìä S·ªë ch∆∞∆°ng c√≤n l·∫°i sau khi x√≥a: ${chapterCount}`);
            
            // ƒê√°nh s·ªë l·∫°i t·∫•t c·∫£ c√°c ch∆∞∆°ng c√≤n l·∫°i (quan tr·ªçng!)
            renumberChapters();
            updateChapterControls();
            
            console.log(`‚úÖ ƒê√£ x√≥a ch∆∞∆°ng th√†nh c√¥ng. C√≤n l·∫°i ${chapterCount} ch∆∞∆°ng`);
            
            // T·ª± ƒë·ªông l∆∞u sau khi x√≥a (optional - c√≥ th·ªÉ b·∫≠t/t·∫Øt)
            // N·∫øu mu·ªën t·ª± ƒë·ªông l∆∞u, uncomment d√≤ng sau:
            // autoSaveAfterDelete();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o nh·∫Øc nh·ªü
            showSaveReminder();
        }
        
        function showSaveReminder() {
            // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
            const oldNotification = document.querySelector('.save-reminder-alert');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            // T·∫°o th√¥ng b√°o m·ªõi
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show mt-2 save-reminder-alert';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Ch∆∞∆°ng ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi form. 
                <strong>Vui l√≤ng click n√∫t "L∆∞u n·ªôi dung preview" b√™n d∆∞·ªõi ƒë·ªÉ l∆∞u thay ƒë·ªïi v√†o database.</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // T√¨m form v√† ch√®n th√¥ng b√°o tr∆∞·ªõc n√∫t submit
            const form = document.getElementById('previewForm');
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.parentElement.insertBefore(notification, submitButton);
                
                // T·ª± ƒë·ªông ·∫©n sau 10 gi√¢y
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 10000);
            }
        }
        
        function autoSaveAfterDelete() {
            // T·ª± ƒë·ªông submit form sau khi x√≥a (c√≥ th·ªÉ g√¢y nhi·ªÅu request)
            console.log('üíæ T·ª± ƒë·ªông l∆∞u sau khi x√≥a ch∆∞∆°ng...');
            const form = document.getElementById('previewForm');
            if (form) {
                // T·∫°o m·ªôt event submit gi·∫£
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(submitEvent);
            }
        }

        function renumberChapters() {
            const chapters = document.querySelectorAll('.chapter-input');
            chapters.forEach((chapter, index) => {
                // T√¨m t·∫•t c·∫£ c√°c input v√† textarea trong ch∆∞∆°ng n√†y
                const titleInput = chapter.querySelector('input[type="text"]');
                const contentTextarea = chapter.querySelector('textarea');
                const label = chapter.querySelector('label');
                
                // C·∫≠p nh·∫≠t name attribute ƒë·ªÉ form submit ƒë√∫ng (b·∫Øt ƒë·∫ßu t·ª´ 0)
                if (titleInput) {
                    titleInput.name = `chapters[${index}][title]`;
                }
                if (contentTextarea) {
                    contentTextarea.name = `chapters[${index}][content]`;
                }
                if (label) {
                    label.textContent = `Ti√™u ƒë·ªÅ ch∆∞∆°ng ${index + 1}`;
                }
            });
        }

        function updateChapterControls() {
            const addBtn = document.getElementById('addChapterBtn');
            if (chapterCount >= 5) {
                addBtn.disabled = true;
                addBtn.innerHTML = '<i class="fas fa-plus"></i> ƒê√£ ƒë·∫°t t·ªëi ƒëa (5 ch∆∞∆°ng)';
            } else {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Th√™m ch∆∞∆°ng';
            }
        }

        // Function ƒë·ªÉ submit form v·ªõi AJAX ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ g·ª≠i c√°c ch∆∞∆°ng c√≤n l·∫°i
        function submitPreviewForm(e) {
            e.preventDefault();
            
            console.log('üìù submitPreviewForm called');
            
            // ƒê·∫£m b·∫£o renumber l·∫°i tr∆∞·ªõc khi submit
            renumberChapters();
            
            const chapters = document.querySelectorAll('.chapter-input');
            console.log(`üìä T·ªïng s·ªë ch∆∞∆°ng trong DOM: ${chapters.length}`);
            
            // Validate s·ªë l∆∞·ª£ng ch∆∞∆°ng
            if (chapters.length < 3) {
                alert('Preview c·∫ßn √≠t nh·∫•t 3 ch∆∞∆°ng');
                return false;
            }
            if (chapters.length > 5) {
                alert('Preview t·ªëi ƒëa 5 ch∆∞∆°ng');
                return false;
            }
            
            // Thu th·∫≠p d·ªØ li·ªáu CH·ªà t·ª´ c√°c ch∆∞∆°ng c√≤n l·∫°i trong DOM
            // L∆∞u √Ω: L·∫•y theo th·ª© t·ª± trong DOM, kh√¥ng ph·∫£i theo name attribute
            const chaptersData = [];
            chapters.forEach((chapter, domIndex) => {
                const titleInput = chapter.querySelector('input[type="text"]');
                const contentTextarea = chapter.querySelector('textarea');
                
                if (titleInput && contentTextarea) {
                    const title = titleInput.value.trim();
                    const content = contentTextarea.value.trim();
                    
                    console.log(`Ch∆∞∆°ng ${domIndex}: title="${title.substring(0, 30)}...", content length=${content.length}`);
                    
                    // Ch·ªâ th√™m n·∫øu c√≥ c·∫£ title v√† content
                    if (title && content) {
                        chaptersData.push({
                            title: title,
                            content: content
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è Ch∆∞∆°ng ${domIndex} b·ªã b·ªè qua v√¨ thi·∫øu title ho·∫∑c content`);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Ch∆∞∆°ng ${domIndex} kh√¥ng t√¨m th·∫•y input ho·∫∑c textarea`);
                }
            });
            
            console.log(`üì¶ S·ªë ch∆∞∆°ng h·ª£p l·ªá ƒë·ªÉ g·ª≠i: ${chaptersData.length}`);
            
            if (chaptersData.length < 3) {
                alert(`Preview c·∫ßn √≠t nh·∫•t 3 ch∆∞∆°ng c√≥ ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung. Hi·ªán t·∫°i c√≥ ${chaptersData.length} ch∆∞∆°ng h·ª£p l·ªá.`);
                return false;
            }
            
            // L·∫•y bookId t·ª´ form
            const form = document.getElementById('previewForm');
            const bookId = form.action.match(/\/admin\/digital-content\/([^\/]+)\/preview/)[1];
            
            // G·ª≠i d∆∞·ªõi d·∫°ng JSON ƒë·ªÉ ƒë·∫£m b·∫£o server nh·∫≠n ƒë∆∞·ª£c array ƒë√∫ng c√°ch
            const requestBody = {
                chapters: chaptersData
            };
            
            console.log(`üì§ Submitting ${chaptersData.length} chapters to server as JSON:`, requestBody);
            
            // G·ª≠i b·∫±ng fetch API v·ªõi JSON
            fetch(`/admin/digital-content/${bookId}/preview`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                console.log('üì• Server response status:', response.status);
                if (response.redirected) {
                    console.log('‚úÖ Server redirecting to:', response.url);
                    // Server redirect v·ªÅ trang manage
                    window.location.href = response.url;
                } else if (response.ok) {
                    return response.json().then(data => {
                        console.log('‚úÖ Server response:', data);
                        window.location.href = `/admin/digital-content/${bookId}/manage`;
                    }).catch(() => {
                        // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, th·ª≠ text
                        return response.text().then(text => {
                            console.log('Server response (text):', text);
                            window.location.href = `/admin/digital-content/${bookId}/manage`;
                        });
                    });
                } else {
                    return response.text().then(text => {
                        console.error('‚ùå Server error response:', text);
                        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u preview: ' + text);
                    });
                }
            })
            .catch(error => {
                console.error('‚ùå Error submitting form:', error);
                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
            });
            
            return false;
        }

        // Initialize controls
        updateChapterControls();
    </script>
</body>
</html>