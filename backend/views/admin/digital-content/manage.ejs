<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        <%- include('../../partials/adminHeader') %>
        .feature-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .feature-card.enabled {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .feature-card.disabled {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        .chapter-input {
            border: 1px dashed #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            background: #fafafa;
        }
        .chapter-input:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        .chapter-file-input {
            font-size: 12px;
            padding: 4px 8px;
        }
        .file-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .chapter-content-textarea {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('../../partials/adminSidebar') %>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                    <h1><%= title %></h1>
                    <div>
                        <a href="/admin/digital-content" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay l·∫°i
                        </a>
                        <span class="badge bg-primary ms-2">Admin: <%= currentUser.username %></span>
                    </div>
                </div>

                <!-- Flash Messages -->
                <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
                    <div class="alert alert-success alert-dismissible fade show mt-3">
                        <%= success_msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible fade show mt-3">
                        <%= error_msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <!-- Book Info -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin s√°ch</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <img src="<%= book.coverImage %>" alt="<%= book.title %>" class="img-fluid rounded">
                            </div>
                            <div class="col-md-10">
                                <h4><%= book.title %></h4>
                                <p class="text-muted"><strong>T√°c gi·∫£:</strong> <%= book.author %></p>
                                <p class="text-muted"><strong>Danh m·ª•c:</strong> <%= book.category?.name || 'Ch∆∞a ph√¢n lo·∫°i' %></p>
                                <p class="text-muted"><strong>Gi√° b√°n:</strong> <%= book.price.toLocaleString('vi-VN') %>‚Ç´</p>
                                <div class="mt-3">
                                    <% if (book.isDigitalAvailable) { %>
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-download"></i> Digital Available
                                        </span>
                                    <% } %>
                                    <% if (book.hasPreview) { %>
                                        <span class="badge bg-info">
                                            <i class="fas fa-eye"></i> Has Preview
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Digital Settings -->
                <div class="feature-card <%= book.isDigitalAvailable ? 'enabled' : 'disabled' %>">
                    <h5>
                        <i class="fas fa-download"></i> C√†i ƒë·∫∑t n·ªôi dung s·ªë
                    </h5>
                    <form method="POST" action="/admin/digital-content/<%= book._id %>/settings">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="isDigitalAvailable" 
                                           name="isDigitalAvailable" <%= book.isDigitalAvailable ? 'checked' : '' %>>
                                    <label class="form-check-label" for="isDigitalAvailable">
                                        B·∫≠t t√≠nh nƒÉng digital
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="coinPrice" class="form-label">Gi√° b·∫±ng Coin</label>
                                    <input type="number" class="form-control" id="coinPrice" name="coinPrice" 
                                           value="<%= book.coinPrice || '' %>" min="0" placeholder="0">
                                    <small class="text-muted">ƒê·ªÉ tr·ªëng ho·∫∑c 0 = mi·ªÖn ph√≠</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="hasPreview" 
                                           name="hasPreview" <%= book.hasPreview ? 'checked' : '' %>>
                                    <label class="form-check-label" for="hasPreview">
                                        B·∫≠t t√≠nh nƒÉng preview
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t
                        </button>
                    </form>
                </div>

                <!-- File Upload -->
                <div class="feature-card">
                    <h5>
                        <i class="fas fa-cloud-upload-alt"></i> Upload file n·ªôi dung
                    </h5>
                    
                    <% if (book.digitalContentPath) { %>
                        <div class="file-info mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>File hi·ªán t·∫°i:</strong> <%= book.digitalContentFilename %><br>
                                    <small class="text-muted">
                                        K√≠ch th∆∞·ªõc: <%= Math.round((book.digitalContentSize || 0) / 1024 / 1024 * 100) / 100 %>MB |
                                        Lo·∫°i: <%= book.digitalContentType %>
                                    </small>
                                </div>
                                <form method="POST" action="/admin/digital-content/<%= book._id %>/delete-file" 
                                      class="d-inline" onsubmit="return confirm('X√°c nh·∫≠n x√≥a file n·ªôi dung?')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash"></i> X√≥a file
                                    </button>
                                </form>
                            </div>
                        </div>
                    <% } %>

                    <form method="POST" action="/admin/digital-content/<%= book._id %>/upload" 
                          enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="contentFile" class="form-label">Ch·ªçn file n·ªôi dung</label>
                            <input class="form-control" type="file" id="contentFile" name="contentFile" 
                                   accept=".txt,.pdf,.epub,.mobi" required>
                            <small class="text-muted">
                                H·ªó tr·ª£: .txt, .pdf, .epub, .mobi (t·ªëi ƒëa 50MB)
                            </small>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload"></i> Upload file
                        </button>
                    </form>
                </div>

                <!-- Preview Content Management -->
                <div class="feature-card">
                    <h5>
                        <i class="fas fa-eye"></i> Qu·∫£n l√Ω n·ªôi dung preview
                    </h5>
                    
                    <% if (previewContent) { %>
                        <div class="alert alert-info mb-3">
                            <strong>Preview hi·ªán t·∫°i:</strong> 
                            <%= previewContent.totalChapters %> ch∆∞∆°ng (DB), 
                            <%= previewContent.chapters ? previewContent.chapters.length : 0 %> ch∆∞∆°ng (array),
                            t·ªïng <%= previewContent.chapters ? previewContent.chapters.reduce((sum, ch) => sum + (ch.wordCount || 0), 0) : 0 %> t·ª´
                            <form method="POST" action="/admin/digital-content/<%= book._id %>/delete-preview" 
                                  class="d-inline ms-3" onsubmit="return confirm('X√°c nh·∫≠n x√≥a to√†n b·ªô preview?')">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    <i class="fas fa-trash"></i> X√≥a preview
                                </button>
                            </form>
                        </div>
                    <% } %>

                    <form method="POST" action="/admin/digital-content/<%= book._id %>/preview" id="previewForm" onsubmit="return submitPreviewForm(event)">
                        <div class="mb-3">
                            <label class="form-label">N·ªôi dung preview (c√≥ th·ªÉ th√™m bao nhi√™u ch∆∞∆°ng c≈©ng ƒë∆∞·ª£c):</label>
                            <div id="chaptersContainer">
                                <% if (previewContent && previewContent.chapters) { %>
                                    <% previewContent.chapters.forEach((chapter, index) => { %>
                                        <div class="chapter-input">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng <%= index + 1 %></label>
                                                    <input type="text" class="form-control" name="chapters[<%= index %>][title]" 
                                                           value="<%= chapter.title %>" required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">N·ªôi dung</label>
                                                    <div class="mb-2">
                                                        <input type="file" class="form-control form-control-sm chapter-file-input" 
                                                               accept=".txt,.md,.markdown,.html,.htm,.doc,.docx,.pdf,.rtf" 
                                                               onchange="handleChapterFileUpload(this, <%= index %>)"
                                                               style="font-size: 12px;">
                                                        <small class="text-muted">Ho·∫∑c upload file (.txt, .md, .html, .doc, .docx, .pdf, .rtf)</small>
                                                    </div>
                                                    <textarea class="form-control chapter-content-textarea" 
                                                              name="chapters[<%= index %>][content]" 
                                                              rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."><%= chapter.content %></textarea>
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button" class="btn btn-outline-danger btn-sm d-block delete-chapter-btn" 
                                                            data-action="delete-chapter" onclick="removeChapter(this)">
                                                        <i class="fas fa-trash"></i> X√≥a
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <!-- Default empty chapters -->
                                    <div class="chapter-input">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng 1</label>
                                                <input type="text" class="form-control" name="chapters[0][title]" 
                                                       required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">N·ªôi dung</label>
                                                <div class="mb-2">
                                                    <input type="file" class="form-control form-control-sm chapter-file-input" 
                                                           accept=".txt,.md,.markdown,.html,.htm,.doc,.docx,.pdf,.rtf" 
                                                           onchange="handleChapterFileUpload(this, 0)"
                                                           style="font-size: 12px;">
                                                    <small class="text-muted">Ho·∫∑c upload file (.txt, .md, .html, .doc, .docx, .pdf, .rtf)</small>
                                                </div>
                                                <textarea class="form-control chapter-content-textarea" 
                                                          name="chapters[0][content]" 
                                                          rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                                        onclick="removeChapter(this)">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chapter-input">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng 2</label>
                                                <input type="text" class="form-control" name="chapters[1][title]" 
                                                       required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">N·ªôi dung</label>
                                                <div class="mb-2">
                                                    <input type="file" class="form-control form-control-sm chapter-file-input" 
                                                           accept=".txt,.md,.markdown,.html,.htm,.doc,.docx,.pdf,.rtf" 
                                                           onchange="handleChapterFileUpload(this, 1)"
                                                           style="font-size: 12px;">
                                                    <small class="text-muted">Ho·∫∑c upload file (.txt, .md, .html, .doc, .docx, .pdf, .rtf)</small>
                                                </div>
                                                <textarea class="form-control chapter-content-textarea" 
                                                          name="chapters[1][content]" 
                                                          rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                                        onclick="removeChapter(this)">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chapter-input">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng 3</label>
                                                <input type="text" class="form-control" name="chapters[2][title]" 
                                                       required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">N·ªôi dung</label>
                                                <div class="mb-2">
                                                    <input type="file" class="form-control form-control-sm chapter-file-input" 
                                                           accept=".txt,.md,.markdown,.html,.htm,.doc,.docx,.pdf,.rtf" 
                                                           onchange="handleChapterFileUpload(this, 2)"
                                                           style="font-size: 12px;">
                                                    <small class="text-muted">Ho·∫∑c upload file (.txt, .md, .html, .doc, .docx, .pdf, .rtf)</small>
                                                </div>
                                                <textarea class="form-control chapter-content-textarea" 
                                                          name="chapters[2][content]" 
                                                          rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger btn-sm d-block" 
                                                        onclick="removeChapter(this)">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="addChapter()" id="addChapterBtn">
                                <i class="fas fa-plus"></i> Th√™m ch∆∞∆°ng
                            </button>
                            <small class="text-muted ms-2">C√≥ th·ªÉ th√™m bao nhi√™u ch∆∞∆°ng c≈©ng ƒë∆∞·ª£c (t·ªëi thi·ªÉu 1 ch∆∞∆°ng)</small>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> L∆∞u n·ªôi dung preview
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chapterCount = document.querySelectorAll('.chapter-input').length;
        
        // Initialize chapter count on page load
        document.addEventListener('DOMContentLoaded', function() {
            chapterCount = document.querySelectorAll('.chapter-input').length;
            updateChapterControls();
            
            // S·ª≠ d·ª•ng event delegation cho n√∫t x√≥a ch∆∞∆°ng
            const chaptersContainer = document.getElementById('chaptersContainer');
            if (chaptersContainer) {
                chaptersContainer.addEventListener('click', function(e) {
                    console.log('Click event in chaptersContainer', e.target);
                    
                    // T√¨m button g·∫ßn nh·∫•t t·ª´ element ƒë∆∞·ª£c click
                    const button = e.target.closest('button');
                    
                    // Ki·ªÉm tra n·∫øu l√† n√∫t x√≥a (c√≥ data-action="delete-chapter" ho·∫∑c ch·ª©a text "X√≥a" ho·∫∑c icon trash)
                    if (button) {
                        const isDeleteButton = button.getAttribute('data-action') === 'delete-chapter' ||
                                             button.textContent.trim().includes('X√≥a') ||
                                             button.querySelector('.fa-trash') ||
                                             e.target.closest('.fa-trash');
                        
                        if (isDeleteButton) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('‚úÖ Delete button clicked', button);
                            removeChapter(button);
                        }
                    }
                });
            } else {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y chaptersContainer element');
            }
        });

        function addChapter() {
            // Kh√¥ng gi·ªõi h·∫°n s·ªë ch∆∞∆°ng - admin c√≥ th·ªÉ th√™m bao nhi√™u ch∆∞∆°ng c≈©ng ƒë∆∞·ª£c
            console.log('‚ûï Adding new chapter, current count:', chapterCount);

            const container = document.getElementById('chaptersContainer');
            if (!container) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y chaptersContainer');
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y container ch∆∞∆°ng');
                return;
            }

            const newChapter = document.createElement('div');
            newChapter.className = 'chapter-input';
            // T·∫°m th·ªùi d√πng chapterCount ƒë·ªÉ ƒë·∫∑t name, s·∫Ω ƒë∆∞·ª£c renumber l·∫°i sau
            newChapter.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Ti√™u ƒë·ªÅ ch∆∞∆°ng ${chapterCount + 1}</label>
                        <input type="text" class="form-control" name="chapters[${chapterCount}][title]" 
                               required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch∆∞∆°ng">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">N·ªôi dung</label>
                        <div class="mb-2">
                            <input type="file" class="form-control form-control-sm chapter-file-input" 
                                   accept=".txt,.md,.markdown,.html,.htm,.doc,.docx,.pdf,.rtf" 
                                   onchange="handleChapterFileUpload(this, ${chapterCount})"
                                   style="font-size: 12px;">
                            <small class="text-muted">Ho·∫∑c upload file (.txt, .md, .html, .doc, .docx, .pdf, .rtf)</small>
                        </div>
                        <textarea class="form-control chapter-content-textarea" 
                                  name="chapters[${chapterCount}][content]" 
                                  rows="4" required placeholder="Nh·∫≠p n·ªôi dung ch∆∞∆°ng..."></textarea>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-outline-danger btn-sm d-block delete-chapter-btn" 
                                data-action="delete-chapter" onclick="removeChapter(this)">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newChapter);
            chapterCount = document.querySelectorAll('.chapter-input').length;
            console.log('‚úÖ Chapter added, new count:', chapterCount);
            
            // ƒê√°nh s·ªë l·∫°i t·∫•t c·∫£ c√°c ch∆∞∆°ng
            renumberChapters();
            updateChapterControls();
            
            // Scroll ƒë·∫øn ch∆∞∆°ng m·ªõi ƒë·ªÉ user d·ªÖ th·∫•y
            newChapter.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Focus v√†o input title c·ªßa ch∆∞∆°ng m·ªõi
            const titleInput = newChapter.querySelector('input[type="text"]');
            if (titleInput) {
                setTimeout(() => titleInput.focus(), 100);
            }
        }

        function removeChapter(button) {
            console.log('üîç removeChapter called', button);
            
            // T√¨m element ch∆∞∆°ng c·∫ßn x√≥a - ƒëi t·ª´ button l√™n ƒë·∫øn khi t√¨m th·∫•y .chapter-input
            let chapterElement = null;
            let current = button;
            
            // T√¨m t·ª´ button ƒëi l√™n
            while (current && current !== document.body) {
                if (current.classList && current.classList.contains('chapter-input')) {
                    chapterElement = current;
                    break;
                }
                current = current.parentElement;
            }
            
            // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, th·ª≠ d√πng closest
            if (!chapterElement) {
                chapterElement = button.closest('.chapter-input');
            }
            
            if (!chapterElement) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y element ch∆∞∆°ng ƒë·ªÉ x√≥a');
                console.log('Button element:', button);
                console.log('Button parent:', button.parentElement);
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng ƒë·ªÉ x√≥a. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            
            console.log('‚úÖ T√¨m th·∫•y chapter element:', chapterElement);
            
            const chapters = document.querySelectorAll('.chapter-input');
            console.log(`üìä T·ªïng s·ªë ch∆∞∆°ng hi·ªán t·∫°i: ${chapters.length}`);
            
            // Ch·ªâ c·∫ßn √≠t nh·∫•t 1 ch∆∞∆°ng
            if (chapters.length <= 1) {
                alert('C·∫ßn √≠t nh·∫•t 1 ch∆∞∆°ng preview');
                return;
            }

            // X√°c nh·∫≠n tr∆∞·ªõc khi x√≥a
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch∆∞∆°ng n√†y?')) {
                return;
            }
            
            console.log('üóëÔ∏è ƒêang x√≥a ch∆∞∆°ng...');
            
            // X√≥a ho√†n to√†n element kh·ªèi DOM
            chapterElement.remove();
            
            // C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng
            chapterCount = document.querySelectorAll('.chapter-input').length;
            console.log(`üìä S·ªë ch∆∞∆°ng c√≤n l·∫°i sau khi x√≥a: ${chapterCount}`);
            
            // ƒê√°nh s·ªë l·∫°i t·∫•t c·∫£ c√°c ch∆∞∆°ng c√≤n l·∫°i (quan tr·ªçng!)
            renumberChapters();
            updateChapterControls();
            
            console.log(`‚úÖ ƒê√£ x√≥a ch∆∞∆°ng th√†nh c√¥ng. C√≤n l·∫°i ${chapterCount} ch∆∞∆°ng`);
            
            // T·ª± ƒë·ªông l∆∞u sau khi x√≥a (optional - c√≥ th·ªÉ b·∫≠t/t·∫Øt)
            // N·∫øu mu·ªën t·ª± ƒë·ªông l∆∞u, uncomment d√≤ng sau:
            // autoSaveAfterDelete();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o nh·∫Øc nh·ªü
            showSaveReminder();
        }
        
        function showSaveReminder() {
            // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
            const oldNotification = document.querySelector('.save-reminder-alert');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            // T·∫°o th√¥ng b√°o m·ªõi
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show mt-2 save-reminder-alert';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Ch∆∞∆°ng ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi form. 
                <strong>Vui l√≤ng click n√∫t "L∆∞u n·ªôi dung preview" b√™n d∆∞·ªõi ƒë·ªÉ l∆∞u thay ƒë·ªïi v√†o database.</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // T√¨m form v√† ch√®n th√¥ng b√°o tr∆∞·ªõc n√∫t submit
            const form = document.getElementById('previewForm');
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.parentElement.insertBefore(notification, submitButton);
                
                // T·ª± ƒë·ªông ·∫©n sau 10 gi√¢y
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 10000);
            }
        }
        
        function autoSaveAfterDelete() {
            // T·ª± ƒë·ªông submit form sau khi x√≥a (c√≥ th·ªÉ g√¢y nhi·ªÅu request)
            console.log('üíæ T·ª± ƒë·ªông l∆∞u sau khi x√≥a ch∆∞∆°ng...');
            const form = document.getElementById('previewForm');
            if (form) {
                // T·∫°o m·ªôt event submit gi·∫£
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(submitEvent);
            }
        }

        function renumberChapters() {
            const chapters = document.querySelectorAll('.chapter-input');
            console.log(`üîÑ Renumbering ${chapters.length} chapters`);
            
            chapters.forEach((chapter, index) => {
                // T√¨m t·∫•t c·∫£ c√°c input v√† textarea trong ch∆∞∆°ng n√†y
                const titleInput = chapter.querySelector('input[type="text"]');
                const contentTextarea = chapter.querySelector('.chapter-content-textarea') || chapter.querySelector('textarea');
                const fileInput = chapter.querySelector('.chapter-file-input') || chapter.querySelector('input[type="file"]');
                const label = chapter.querySelector('label');
                
                // C·∫≠p nh·∫≠t name attribute ƒë·ªÉ form submit ƒë√∫ng (b·∫Øt ƒë·∫ßu t·ª´ 0)
                // L∆∞u √Ω: name attribute kh√¥ng quan tr·ªçng v√¨ ch√∫ng ta d√πng JSON submit
                // nh∆∞ng v·∫´n c·∫≠p nh·∫≠t ƒë·ªÉ nh·∫•t qu√°n
                if (titleInput) {
                    titleInput.name = `chapters[${index}][title]`;
                }
                if (contentTextarea) {
                    contentTextarea.name = `chapters[${index}][content]`;
                }
                // C·∫≠p nh·∫≠t onchange cho file input v·ªõi index m·ªõi
                if (fileInput) {
                    fileInput.setAttribute('onchange', `handleChapterFileUpload(this, ${index})`);
                }
                if (label && !label.textContent.includes('N·ªôi dung')) {
                    label.textContent = `Ti√™u ƒë·ªÅ ch∆∞∆°ng ${index + 1}`;
                }
            });
            
            console.log(`‚úÖ Renumbered ${chapters.length} chapters`);
        }

        function updateChapterControls() {
            const addBtn = document.getElementById('addChapterBtn');
            // Kh√¥ng gi·ªõi h·∫°n s·ªë ch∆∞∆°ng - lu√¥n enable button
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Th√™m ch∆∞∆°ng';
        }

        // Function ƒë·ªÉ submit form v·ªõi AJAX ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ g·ª≠i c√°c ch∆∞∆°ng c√≤n l·∫°i
        function submitPreviewForm(e) {
            e.preventDefault();
            
            console.log('üìù submitPreviewForm called');
            
            // ƒê·∫£m b·∫£o renumber l·∫°i tr∆∞·ªõc khi submit
            renumberChapters();
            
            const chapters = document.querySelectorAll('.chapter-input');
            console.log(`üìä T·ªïng s·ªë ch∆∞∆°ng trong DOM: ${chapters.length}`);
            
            // Validate s·ªë l∆∞·ª£ng ch∆∞∆°ng - ch·ªâ c·∫ßn √≠t nh·∫•t 1 ch∆∞∆°ng
            if (chapters.length < 1) {
                alert('Preview c·∫ßn √≠t nh·∫•t 1 ch∆∞∆°ng');
                return false;
            }
            // Kh√¥ng gi·ªõi h·∫°n s·ªë ch∆∞∆°ng t·ªëi ƒëa
            
            console.log(`üìã B·∫Øt ƒë·∫ßu thu th·∫≠p d·ªØ li·ªáu t·ª´ ${chapters.length} ch∆∞∆°ng trong DOM`);
            
            // Thu th·∫≠p d·ªØ li·ªáu CH·ªà t·ª´ c√°c ch∆∞∆°ng c√≤n l·∫°i trong DOM
            // L∆∞u √Ω: L·∫•y theo th·ª© t·ª± trong DOM, kh√¥ng ph·∫£i theo name attribute
            const chaptersData = [];
            chapters.forEach((chapter, domIndex) => {
                const titleInput = chapter.querySelector('input[type="text"]');
                const contentTextarea = chapter.querySelector('.chapter-content-textarea') || chapter.querySelector('textarea');
                
                if (titleInput && contentTextarea) {
                    const title = titleInput.value.trim();
                    const content = contentTextarea.value.trim();
                    
                    console.log(`Ch∆∞∆°ng ${domIndex + 1}: title="${title.substring(0, 30)}...", content length=${content.length}`);
                    
                    // Ch·ªâ th√™m n·∫øu c√≥ c·∫£ title v√† content (kh√¥ng r·ªóng)
                    if (title && content) {
                        chaptersData.push({
                            title: title,
                            content: content
                        });
                        console.log(`‚úÖ ƒê√£ th√™m ch∆∞∆°ng ${domIndex + 1} v√†o danh s√°ch g·ª≠i`);
                    } else {
                        console.warn(`‚ö†Ô∏è Ch∆∞∆°ng ${domIndex + 1} b·ªã b·ªè qua v√¨ thi·∫øu title ho·∫∑c content (title: "${title}", content length: ${content.length})`);
                        // Hi·ªÉn th·ªã c·∫£nh b√°o cho user n·∫øu ch∆∞∆°ng b·ªã b·ªè qua
                        if (!title || !content) {
                            const chapterLabel = chapter.querySelector('label');
                            const chapterTitle = chapterLabel ? chapterLabel.textContent : `Ch∆∞∆°ng ${domIndex + 1}`;
                            console.warn(`‚ö†Ô∏è ${chapterTitle} s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u v√¨ thi·∫øu th√¥ng tin`);
                        }
                    }
                } else {
                    console.error(`‚ùå Ch∆∞∆°ng ${domIndex + 1} kh√¥ng t√¨m th·∫•y input ho·∫∑c textarea`);
                    console.error('Title input:', titleInput);
                    console.error('Content textarea:', contentTextarea);
                }
            });
            
            console.log(`üì¶ S·ªë ch∆∞∆°ng h·ª£p l·ªá ƒë·ªÉ g·ª≠i: ${chaptersData.length} / ${chapters.length} ch∆∞∆°ng trong DOM`);
            
            if (chaptersData.length < 1) {
                alert(`Preview c·∫ßn √≠t nh·∫•t 1 ch∆∞∆°ng c√≥ ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung. Hi·ªán t·∫°i c√≥ ${chaptersData.length} ch∆∞∆°ng h·ª£p l·ªá trong s·ªë ${chapters.length} ch∆∞∆°ng.`);
                return false;
            }
            
            // C·∫£nh b√°o n·∫øu c√≥ ch∆∞∆°ng b·ªã b·ªè qua
            if (chaptersData.length < chapters.length) {
                const skipped = chapters.length - chaptersData.length;
                if (!confirm(`C√≥ ${skipped} ch∆∞∆°ng ch∆∞a c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?`)) {
                    return false;
                }
            }
            
            // L·∫•y bookId t·ª´ form
            const form = document.getElementById('previewForm');
            const bookId = form.action.match(/\/admin\/digital-content\/([^\/]+)\/preview/)[1];
            
            // G·ª≠i d∆∞·ªõi d·∫°ng JSON ƒë·ªÉ ƒë·∫£m b·∫£o server nh·∫≠n ƒë∆∞·ª£c array ƒë√∫ng c√°ch
            const requestBody = {
                chapters: chaptersData
            };
            
            console.log(`üì§ Submitting ${chaptersData.length} chapters to server as JSON:`, requestBody);
            console.log(`üìã Chi ti·∫øt c√°c ch∆∞∆°ng:`, chaptersData.map((ch, idx) => `${idx + 1}. "${ch.title.substring(0, 30)}..." (${ch.content.length} k√Ω t·ª±)`));
            
            // G·ª≠i b·∫±ng fetch API v·ªõi JSON
            fetch(`/admin/digital-content/${bookId}/preview`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                console.log('üì• Server response status:', response.status);
                console.log('üì• Server response headers:', response.headers);
                
                // Ki·ªÉm tra content type
                const contentType = response.headers.get('content-type');
                console.log('üì• Content-Type:', contentType);
                
                if (response.redirected) {
                    console.log('‚úÖ Server redirecting to:', response.url);
                    // Server redirect v·ªÅ trang manage (th∆∞·ªùng l√† th√†nh c√¥ng)
                    window.location.href = response.url;
                } else if (response.ok) {
                    // N·∫øu response l√† JSON
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => {
                            console.log('‚úÖ Server response (JSON):', data);
                            if (data.success !== false) {
                                alert(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng ${chaptersData.length} ch∆∞∆°ng!`);
                                window.location.href = `/admin/digital-content/${bookId}/manage`;
                            } else {
                                alert('‚ùå L·ªói: ' + (data.error || data.message || 'Kh√¥ng th·ªÉ l∆∞u preview'));
                            }
                        }).catch(err => {
                            console.error('‚ùå Error parsing JSON:', err);
                            return response.text().then(text => {
                                console.log('Server response (text):', text);
                                window.location.href = `/admin/digital-content/${bookId}/manage`;
                            });
                        });
                    } else {
                        // N·∫øu response l√† HTML (redirect ho·∫∑c error page)
                        return response.text().then(text => {
                            console.log('Server response (HTML/text):', text.substring(0, 500));
                            // N·∫øu c√≥ ch·ª©a error message, hi·ªÉn th·ªã
                            if (text.includes('error') || text.includes('l·ªói')) {
                                alert('‚ö†Ô∏è C√≥ th·ªÉ c√≥ l·ªói x·∫£y ra. Vui l√≤ng ki·ªÉm tra l·∫°i.');
                            }
                            window.location.href = `/admin/digital-content/${bookId}/manage`;
                        });
                    }
                } else {
                    // Response kh√¥ng OK (4xx, 5xx)
                    console.error('‚ùå Server returned error status:', response.status);
                    return response.text().then(text => {
                        console.error('‚ùå Server error response:', text);
                        let errorMsg = 'C√≥ l·ªói x·∫£y ra khi l∆∞u preview';
                        try {
                            // Th·ª≠ parse JSON error
                            const errorData = JSON.parse(text);
                            errorMsg = errorData.error || errorData.message || errorData.details || errorMsg;
                            console.error('‚ùå Parsed error data:', errorData);
                        } catch (e) {
                            // N·∫øu kh√¥ng ph·∫£i JSON, l·∫•y text
                            console.error('‚ùå Error response is not JSON, raw text:', text);
                            if (text.length < 500) {
                                errorMsg = text;
                            } else {
                                errorMsg = text.substring(0, 200) + '...';
                            }
                        }
                        alert('‚ùå L·ªói: ' + errorMsg + '\n\nVui l√≤ng ki·ªÉm tra console ƒë·ªÉ xem chi ti·∫øt.');
                    }).catch(err => {
                        console.error('‚ùå Error reading error response:', err);
                        alert('‚ùå C√≥ l·ªói x·∫£y ra khi ƒë·ªçc ph·∫£n h·ªìi t·ª´ server. Vui l√≤ng ki·ªÉm tra console.');
                    });
                }
            })
            .catch(error => {
                console.error('‚ùå Error submitting form:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu: ' + error.message);
            });
            
            return false;
        }

        // Initialize controls
        updateChapterControls();

        // H√†m x·ª≠ l√Ω upload file cho t·ª´ng ch∆∞∆°ng
        function handleChapterFileUpload(input, chapterIndex) {
            const file = input.files[0];
            if (!file) {
                return;
            }

            console.log(`üìÑ Uploading file for chapter ${chapterIndex + 1}:`, file.name, file.type, file.size);

            // T√¨m textarea t∆∞∆°ng ·ª©ng
            const chapterElement = input.closest('.chapter-input');
            if (!chapterElement) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y chapter element');
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng t∆∞∆°ng ·ª©ng');
                return;
            }

            const textarea = chapterElement.querySelector('.chapter-content-textarea');
            if (!textarea) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y textarea');
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y textarea ƒë·ªÉ ƒëi·ªÅn n·ªôi dung');
                return;
            }

            // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('File qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 10MB.');
                input.value = '';
                return;
            }

            // Hi·ªÉn th·ªã loading
            const originalPlaceholder = textarea.placeholder;
            textarea.placeholder = 'ƒêang upload v√† ƒë·ªçc file...';
            textarea.disabled = true;
            input.disabled = true;

            // T·∫°o FormData ƒë·ªÉ upload file
            const formData = new FormData();
            formData.append('chapterFile', file);

            // Upload file l√™n server
            fetch('/admin/api/digital-content/upload-chapter-file', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('üì• Server response status:', response.status);
                return response.json();
            })
            .then(data => {
                input.disabled = false;
                
                if (data.success && data.content) {
                    // ƒêi·ªÅn n·ªôi dung v√†o textarea
                    textarea.value = data.content;
                    textarea.disabled = false;
                    textarea.placeholder = originalPlaceholder;

                    console.log(`‚úÖ ƒê√£ ƒë·ªçc file th√†nh c√¥ng, n·ªôi dung: ${data.content.length} k√Ω t·ª±`);
                    
                    // Th√¥ng b√°o th√†nh c√¥ng
                    const successMsg = document.createElement('small');
                    successMsg.className = 'text-success';
                    successMsg.textContent = `‚úì ƒê√£ t·∫£i n·ªôi dung t·ª´ file "${data.fileName}" (${data.fileSize} k√Ω t·ª±)`;
                    successMsg.style.display = 'block';
                    successMsg.style.marginTop = '4px';
                    
                    // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
                    const oldMsg = input.parentElement.querySelector('.text-success');
                    if (oldMsg) {
                        oldMsg.remove();
                    }
                    
                    input.parentElement.appendChild(successMsg);
                    
                    // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
                    setTimeout(() => {
                        if (successMsg.parentElement) {
                            successMsg.style.opacity = '0';
                            successMsg.style.transition = 'opacity 0.5s';
                            setTimeout(() => successMsg.remove(), 500);
                        }
                    }, 5000);
                } else {
                    // L·ªói t·ª´ server
                    const errorMsg = data.error || 'Kh√¥ng th·ªÉ ƒë·ªçc file';
                    alert('‚ùå L·ªói: ' + errorMsg);
                    textarea.disabled = false;
                    textarea.placeholder = originalPlaceholder;
                    input.value = '';
                }
            })
            .catch(error => {
                console.error('‚ùå Error uploading file:', error);
                alert('‚ùå L·ªói khi upload file: ' + error.message);
                textarea.disabled = false;
                textarea.placeholder = originalPlaceholder;
                input.disabled = false;
                input.value = '';
            });
        }
    </script>
</body>
</html>