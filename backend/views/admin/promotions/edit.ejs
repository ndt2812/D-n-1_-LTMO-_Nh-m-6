<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        <%- include('../../partials/adminHeader') %>
        .form-section {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .usage-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('../../partials/adminSidebar') %>

            <!-- Main Content -->
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                    <h1><%= title %></h1>
                    <div>
                        <a href="/admin/promotions" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                        <span class="badge bg-primary ms-2">Admin: <%= currentUser.username %></span>
                    </div>
                </div>

                <!-- Flash Messages -->
                <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
                    <div class="alert alert-success alert-dismissible fade show mt-3">
                        <%= success_msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible fade show mt-3">
                        <%= error_msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>

                <!-- Usage Warning -->
                <% if (promotion.currentUsage > 0) { %>
                    <div class="usage-warning mt-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            <div>
                                <strong>Lưu ý:</strong> Mã này đã được sử dụng <%= promotion.currentUsage %> lần. 
                                Một số thay đổi có thể bị hạn chế để đảm bảo tính nhất quán.
                            </div>
                        </div>
                    </div>
                <% } %>

                <!-- Current Status -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle"></i> Thông tin hiện tại
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Mã:</strong> <span class="text-primary"><%= promotion.code %></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Trạng thái:</strong> 
                                <% if (promotion.isActive && new Date() < promotion.endDate) { %>
                                    <span class="badge bg-success">Hoạt động</span>
                                <% } else if (!promotion.isActive) { %>
                                    <span class="badge bg-secondary">Đã tắt</span>
                                <% } else { %>
                                    <span class="badge bg-danger">Hết hạn</span>
                                <% } %>
                            </div>
                            <div class="col-md-3">
                                <strong>Sử dụng:</strong> 
                                <%= promotion.currentUsage %><% if (promotion.maxUsage) { %>/<%= promotion.maxUsage %><% } %>
                            </div>
                            <div class="col-md-3">
                                <strong>Tạo lúc:</strong> 
                                <%= new Date(promotion.createdAt).toLocaleDateString('vi-VN') %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Promotion Form -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-edit"></i> Chỉnh sửa mã khuyến mãi
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/admin/promotions/<%= promotion._id %>/edit">
                            <!-- Basic Information -->
                            <div class="form-section">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-info-circle"></i> Thông tin cơ bản
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="code" class="form-label">Mã khuyến mãi</label>
                                            <input type="text" class="form-control" id="code" name="code" 
                                                   value="<%= promotion.code %>" disabled>
                                            <small class="form-text text-muted">
                                                Mã không thể thay đổi sau khi tạo
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="description" class="form-label">
                                                Mô tả <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="description" name="description" 
                                                   value="<%= promotion.description %>" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Discount Settings -->
                            <div class="form-section">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-percentage"></i> Cài đặt giảm giá
                                </h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="discountType" class="form-label">
                                                Loại giảm giá <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" id="discountType" name="discountType" required>
                                                <option value="percentage" <%= promotion.discountType === 'percentage' ? 'selected' : '' %>>
                                                    Phần trăm (%)
                                                </option>
                                                <option value="fixed" <%= promotion.discountType === 'fixed' ? 'selected' : '' %>>
                                                    Số tiền cố định (₫)
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="discountValue" class="form-label">
                                                Giá trị giảm <span class="text-danger">*</span>
                                            </label>
                                            <input type="number" class="form-control" id="discountValue" name="discountValue" 
                                                   value="<%= promotion.discountValue %>" required min="0" step="0.01">
                                            <small class="form-text text-muted" id="discountHelp">
                                                <%= promotion.discountType === 'percentage' ? 'Nhập % từ 1-100' : 'Nhập số tiền' %>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="minimumPurchase" class="form-label">Đơn hàng tối thiểu (₫)</label>
                                            <input type="number" class="form-control" id="minimumPurchase" name="minimumPurchase" 
                                                   value="<%= promotion.minimumPurchase %>" min="0" step="1000">
                                            <small class="form-text text-muted">
                                                0 = Không giới hạn
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Usage Limits -->
                            <div class="form-section">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-chart-bar"></i> Giới hạn sử dụng
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="maxUsage" class="form-label">Số lượt sử dụng tối đa</label>
                                            <input type="number" class="form-control" id="maxUsage" name="maxUsage" 
                                                   value="<%= promotion.maxUsage || '' %>" min="<%= promotion.currentUsage || 1 %>"
                                                   placeholder="Để trống = không giới hạn">
                                            <small class="form-text text-muted">
                                                <% if (promotion.currentUsage > 0) { %>
                                                    Tối thiểu: <%= promotion.currentUsage %> (đã sử dụng)
                                                <% } else { %>
                                                    Tổng số lần có thể sử dụng mã này
                                                <% } %>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Trạng thái</label>
                                            <div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="isActive" name="isActive" 
                                                           <%= promotion.isActive ? 'checked' : '' %>>
                                                    <label class="form-check-label" for="isActive">
                                                        Kích hoạt mã khuyến mãi
                                                    </label>
                                                </div>
                                                <small class="form-text text-muted">
                                                    Tắt để tạm dừng mà không xóa mã
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Time Settings -->
                            <div class="form-section">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-calendar"></i> Thời gian hiệu lực
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="startDate" class="form-label">
                                                Ngày bắt đầu <span class="text-danger">*</span>
                                            </label>
                                            <input type="datetime-local" class="form-control" id="startDate" name="startDate" 
                                                   value="<%= new Date(promotion.startDate.getTime() - promotion.startDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16) %>" 
                                                   required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="endDate" class="form-label">
                                                Ngày kết thúc <span class="text-danger">*</span>
                                            </label>
                                            <input type="datetime-local" class="form-control" id="endDate" name="endDate" 
                                                   value="<%= new Date(promotion.endDate.getTime() - promotion.endDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16) %>" 
                                                   required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Application Scope -->
                            <div class="form-section">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-filter"></i> Phạm vi áp dụng
                                    <small class="fw-normal text-muted">(Tùy chọn - để trống để áp dụng cho tất cả)</small>
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="applicableCategories" class="form-label">Danh mục áp dụng</label>
                                            <select class="form-select" id="applicableCategories" name="applicableCategories" multiple size="5">
                                                <% categories.forEach(category => { 
                                                    const isSelected = promotion.applicableCategories.some(cat => cat._id.toString() === category._id.toString());
                                                %>
                                                    <option value="<%= category._id %>" <%= isSelected ? 'selected' : '' %>>
                                                        <%= category.name %>
                                                    </option>
                                                <% }) %>
                                            </select>
                                            <small class="form-text text-muted">
                                                Giữ Ctrl để chọn nhiều danh mục
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="applicableBooks" class="form-label">Sách cụ thể</label>
                                            <select class="form-select" id="applicableBooks" name="applicableBooks" multiple size="5">
                                                <% books.forEach(book => { 
                                                    const isSelected = promotion.applicableBooks.some(b => b._id.toString() === book._id.toString());
                                                %>
                                                    <option value="<%= book._id %>" <%= isSelected ? 'selected' : '' %>>
                                                        <%= book.title %> - <%= book.category?.name || 'Chưa phân loại' %>
                                                    </option>
                                                <% }) %>
                                            </select>
                                            <small class="form-text text-muted">
                                                Giữ Ctrl để chọn nhiều sách
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex justify-content-between">
                                <a href="/admin/promotions" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Hủy bỏ
                                </a>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Cập nhật mã khuyến mãi
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Additional Actions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-tools"></i> Thao tác khác
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <form method="POST" action="/admin/promotions/<%= promotion._id %>/toggle" class="d-inline"
                                      onsubmit="return confirm('Xác nhận thay đổi trạng thái mã khuyến mãi?')">
                                    <button type="submit" class="btn <%= promotion.isActive ? 'btn-warning' : 'btn-success' %>">
                                        <i class="fas <%= promotion.isActive ? 'fa-pause' : 'fa-play' %>"></i>
                                        <%= promotion.isActive ? 'Tạm dừng' : 'Kích hoạt' %>
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6 text-end">
                                <% if (promotion.currentUsage === 0) { %>
                                    <form method="POST" action="/admin/promotions/<%= promotion._id %>/delete" class="d-inline"
                                          onsubmit="return confirm('Xác nhận xóa mã khuyến mãi này? Hành động không thể hoàn tác!')">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash"></i> Xóa mã
                                        </button>
                                    </form>
                                <% } else { %>
                                    <button type="button" class="btn btn-secondary" disabled title="Không thể xóa mã đã được sử dụng">
                                        <i class="fas fa-lock"></i> Không thể xóa
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update discount help text
        document.getElementById('discountType').addEventListener('change', function() {
            const helpText = document.getElementById('discountHelp');
            const discountValue = document.getElementById('discountValue');
            
            if (this.value === 'percentage') {
                helpText.textContent = 'Nhập % từ 1-100';
                discountValue.max = '100';
            } else {
                helpText.textContent = 'Nhập số tiền (₫)';
                discountValue.max = '';
            }
        });

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value);

            // Validate dates
            if (startDate >= endDate) {
                e.preventDefault();
                alert('Ngày kết thúc phải sau ngày bắt đầu');
                return;
            }

            // Validate discount value
            if (discountType === 'percentage' && (discountValue <= 0 || discountValue > 100)) {
                e.preventDefault();
                alert('Phần trăm giảm giá phải từ 1 đến 100');
                return;
            }

            if (discountType === 'fixed' && discountValue <= 0) {
                e.preventDefault();
                alert('Số tiền giảm phải lớn hơn 0');
                return;
            }
        });
    </script>
</body>
</html>